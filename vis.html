<script src="vis-data.js"></script>
<script src="node_modules/d3/d3.js"></script>
<meta charset="utf-8" />

<div id="info" style="position: absolute; width: 100%; left: 0; top: 0; background: white"></div>


<style>

.selected {
    stroke: green;
}

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

.stack-frame {
    overflow: hidden;

}
.stack-frame__file-and-function {
    float: left;
    width: 40%;
}
.stack-frame__source {
    float: left;
    width: 60%;
}

</style>

<div id="viz"></div>
<script>

function showInfo(info){
    var html = "<b>" + info.action + "</b>"
    if (info.resolvedStack) {
        info.resolvedStack.forEach(function(frame){
            var fileNameParts = frame.fileName.split("/")
            var fileName = fileNameParts[fileNameParts.length - 1]
            html += `<div class="stack-frame">
                <div class="stack-frame__file-and-function">
                    ${fileName} / ${frame.functionName}
                </div>
                <div class="stack-frame__source">
                    ${frame.line.replace(/\</g, "&lt;").replace(/\>/g, "&gt;")}
                </div>
            </div>`;
        })
    }
    document.getElementById("info").innerHTML = html
}
var width = 1050,
    height = 950;

var force = d3.layout.force()
    .charge(-300)
    .linkDistance(60)
    .size([width, height]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

// var graph =  {
//     nodes: [
//         {name: "cake"},
//         {name: "cookie"},
//         {name: "hello"}
//     ],
//     links: [
//         {source: 0, target: 1, value: 88},
//         {source: 0, target: 2, value: 33}
//     ]
// }

var nodes= [];
var links = [];

processOriginObject(window.visOriginData)
function processOriginObject(origin){
    var index = nodes.length;
    nodes.push({
        originObj: origin,
        value: origin.value,
        action: origin.action + (origin.elIdentifier ? " " + origin.elIdentifier : ""),
        isRootNode: index ===0
    })

    if (origin.inputValues) {
        origin.inputValues.forEach(function(inputValue){
            if (inputValue===null){return}
            var inputIndex = processOriginObject(inputValue)
            links.push({
                source: index,
                target: inputIndex,
                value: 20
            })
        })
    }
    if (origin.children){
        origin.children.forEach(function(child){
            var childIndex = processOriginObject(child)
            links.push({
                source: index,
                target: childIndex,
                value: 20
            })
        })
    }

    return index;
}


var graph = {
    nodes: nodes,
    links: links
}

  force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();

  var link = svg.selectAll(".link")
      .data(graph.links)
    .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

  var node = svg.selectAll(".node")
      .data(graph.nodes)
    .enter()
    .append("g")

    node.append("circle")
      .attr("class", "node")
      .attr("r", 5)
      .call(force.drag)

      node.append("text")
        .style("font-size", 12)
        .text(function(d) {
            var text = d.action;
            if (d.action === "string literal"){
                var truncatedValue = d.value
                if (truncatedValue.length > 25) {
                    truncatedValue = truncatedValue.substr(0, 25) + "..."
                }
                text = '"' + truncatedValue + '"'
            }
            text = text.replace(/\n/g, "\\n")
            return text;
        })
        .on("mouseenter", function(d){
            var currentSelection = document.querySelector(".selected")
            if (currentSelection) {
                currentSelection.classList.remove("selected")
            }

            this.classList.add("selected")

            showInfo(d.originObj);
            console.log(d)
        })


  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });


    node.selectAll("circle")
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; })
        .attr("fill", function(d){
            return d.isRootNode ? "red" : "black"
        })


    node.selectAll("text")
        .attr("transform", function(d){
            var x = d.x;
            var y=  d.y;
            return "translate(" + x + "," + y + ")"
        })
  });
</script>
