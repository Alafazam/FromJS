<script src="vis-data.js"></script>
<script src="node_modules/d3/d3.js"></script>
<meta charset="utf-8" />

<div id="info" style="position: absolute; width: 100%; left: 0; top: 0; background: white"></div>


<style>

blockquote {
    padding-left: 10px;
    margin: 0
}

.selected {
    stroke: green;
}

.stack-frame--highlight {
    font-weight: bold
}

.stack-frame--library {
    opacity: .5;
}

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

.stack-frame {
    overflow: hidden;
    font-family: monospace;
}
.stack-frame__file-and-function {
    float: left;
    width: 40%;
}
.stack-frame__source {
    float: left;
    width: 60%;
}

</style>

<div id="viz"></div>
<script>

function nodeIsHTMLElement(node){
    return node.action === "initial html" || node.action === "content from initial html" ||
        node.action === "createElement" || node.action === "assign innerHTML" ||
        node.action === "appendChild"
}

function nodeIsValueSource(node){
    return node.action === "string literal" || node.action === "localStorage.getItem"
}

function showInfo(info){
    var html = "<u>" + info.action + " </u><br/>"
    html += "<blockquote>" + escapeAngleBrackets(info.value ? info.value : "") + "</blockquote>"
    console.log("html is", html)
    var hasHighlighted = false
    if (info.resolvedStack) {
        info.resolvedStack.forEach(function(frame){
            var fileNameParts = frame.fileName.split("/")
            var fileName = fileNameParts[fileNameParts.length - 1]

            var isLibrary = fileName.indexOf("underscore") !== -1 || fileName.indexOf("jquery") !== -1

            var isLibraryClass = isLibrary ? "stack-frame--library" : ""

            var highlightClass = "";
            if (!hasHighlighted) {
                if (!isLibrary){
                    highlightClass = "stack-frame--highlight"
                    hasHighlighted = true
                }

            }

            var line = escapeAngleBrackets(frame.line.substr(0, frame.columnNumber)) +
                "<span style='color: red; '>|</span>" +
                escapeAngleBrackets(frame.line.substr(frame.columnNumber));


            html += `<div class="stack-frame ${highlightClass} ${isLibraryClass}">
                <div class="stack-frame__file-and-function">
                    ${fileName}:${frame.lineNumber} / ${frame.functionName}
                </div>
                <div class="stack-frame__source ">
                    ${line}
                </div>
            </div>`;
        })
    }
    console.log("set html")
    document.getElementById("info").innerHTML = html
}

function escapeAngleBrackets(str){
    return str.replace(/\</g, "&lt;").replace(/\>/g, "&gt;")
}

var width = 1050,
    height = 950;

var force = d3.layout.force()
    .charge(-300)
    .linkDistance(60)
    .size([width, height]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var nodes= [];
var links = [];

// processOriginObject(window.visOriginData)
processOriginObject(JSON.parse(localStorage.getItem("visData")))
function processOriginObject(origin){
    var index = nodes.length;
    origin.index = index;
    nodes.push(origin)

    if (origin.inputValues) {
        origin.inputValues.forEach(function(inputValue){
            if (inputValue===null){return}
            var inputIndex = processOriginObject(inputValue)
            links.push({
                source: index,
                target: inputIndex,
                value: 20
            })
        })
    }
    if (origin.children){
        origin.children.forEach(function(child){
            var childIndex = processOriginObject(child)
            links.push({
                source: index,
                target: childIndex,
                value: 20
            })
        })
    }

    return index;
}


var graph = {
    nodes: nodes,
    links: links
}

  force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();

  var link = svg.selectAll(".link")
      .data(graph.links)
    .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

  var node = svg.selectAll(".node")
      .data(graph.nodes)
    .enter()
    .append("g")

    node.append("circle")
      .attr("class", "node")
      .attr("r", 5)
      .call(force.drag)

      node.append("text")
        .style("font-size", 12)
        .text(function(d) {
            var text = d.action + (d.actionDetails ? " " + d.actionDetails : "");
            if (d.action === "string literal"){
                var truncatedValue = d.value
                if (truncatedValue.length > 25) {
                    truncatedValue = truncatedValue.substr(0, 25) + "..."
                }
                text = '"' + truncatedValue + '"'
            }
            text = text.replace(/\n/g, "\\n")
            return text;
        })
        .on("mouseenter", function(d){
            var currentSelection = document.querySelector(".selected")
            if (currentSelection) {
                currentSelection.classList.remove("selected")
            }

            this.classList.add("selected")

            showInfo(d);
            console.log(d)
        })


  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });


    node.selectAll("circle")
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; })
        .attr("fill", function(d){
            if (d.index === 0) {
                return "red"
            }
            if (nodeIsHTMLElement(d)){
                return "blue"
            }
            if (nodeIsValueSource(d)){
                return "orange"
            }
            return "black"
        })


    node.selectAll("text")
        .attr("transform", function(d){
            var x = d.x;
            var y=  d.y;
            return "translate(" + x + "," + y + ")"
        })
  });
</script>
